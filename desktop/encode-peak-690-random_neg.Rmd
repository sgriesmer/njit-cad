```{r front, child="front.Rmd", echo=FALSE}
```

## Dependencies

This document has the following dependencies:

```{r dependencies, warning=FALSE, message=FALSE}
library(GenomicRanges)
library(rtracklayer)
library(AnnotationHub)
library(TFutils)
```

## Use TFutils to get ENCODE 690 dataset

```{r tfutils}
names(TFutils::encode690)
TFutils::encode690[,1:5]
df1 = TFutils::encode690["title"][1]
df1[[1]]
```

Lets take a look at one dataset for the TF for the BRCA1 gene from the Gm12878 cell line:

```{r ahub_GR}
ah = AnnotationHub()
tfbs_title = df1[[1]][73] # wgEncodeAwgTfbsBroadHuvecPol2bUniPk.narrowPeak.gz
gr1 <- subset(ah, title == tfbs_title)[[1]]
gr1
```

There are 551 TFs in the dataset. Let's look at the distribution of sizes.

```{r ahub_summary}
summary(width(gr1))
table(width(gr1))
```

Most peaks in gr1 have a width of 296bp.

Let's get the center 101bp coordinates of the TF.

```{r ahub_resize}
dnabert_input = resize(gr1, width = 101, fix = "center")
table(width(dnabert_input))
```

Look at sequences

```{r get_sequences}
library(memes)
human_genome = BSgenome.Hsapiens.UCSC.hg19
dnabert_input_dss = get_sequence(dnabert_input, human_genome)
dnabert_input_dss
```

Find random sequence with width of 101 and same GC content

```{r find_random_sample_of_101bp_segment}
find_random_seq = function(pos_seq, genome, tfbs_gr) {
  GC_content_seq = letterFrequency(pos_seq, "GC", as.prob = TRUE)
  autosome = paste0('chr', 1:22)
  sex_chrom = c('chrX', 'chrY')
  full_chrom = c(autosome, sex_chrom)
  ran_chrom = sample(full_chrom, 1)
  ran_chrom_seq = human_genome[[ran_chrom]]
  ran_chrom_length = length(ran_chrom_seq)
  ran_start = sample(1:ran_chrom_length-100,1)
  ran_end = ran_start + 100
  ran_segment = paste(ran_chrom, ":", ran_start, "-", ran_end, sep="")
  ran_sequence = get_sequence(ran_segment, human_genome)
  ran_sequence_gc = letterFrequency(ran_sequence, "GC", as.prob = TRUE)
  ran_gr = GRanges(seqnames=ran_chrom, ranges=IRanges(start=ran_start, width=101))
  try = 1
  while (countOverlaps(ran_gr,tfbs_gr) != 0 | abs(ran_sequence_gc - GC_content_seq) >= 0.01) {
    ran_chrom = sample(full_chrom, 1)
    ran_chrom_seq = human_genome[[ran_chrom]]
    ran_chrom_length = length(ran_chrom_seq)
    ran_start = sample(1:ran_chrom_length-100,1)
    ran_end = ran_start + 100
    ran_segment = paste(ran_chrom, ":", ran_start, "-", ran_end, sep="")
    ran_sequence = get_sequence(ran_segment, human_genome)
    ran_sequence_gc = letterFrequency(ran_sequence, "GC", as.prob = TRUE)
    ran_gr = GRanges(seqnames=ran_chrom, ranges=IRanges(start=ran_start, width=101))
    try = try + 1
  }
  ran_sequence
}

# find_random_seq(dnabert_input_dss[1],human_genome,dnabert_input)

```

```{r write_tfbs_gr_to_bedfile}
df <- data.frame(seqnames=seqnames(dnabert_input),
  starts=start(dnabert_input)-1,
  ends=end(dnabert_input),
  names=c(rep(".", length(dnabert_input))),
  scores=c(rep(".", length(dnabert_input))),
  strands=strand(dnabert_input))

df

write.table(df, file="dnabert_input.bed", quote=F, sep="\t", row.names=F, col.names=F)

```

```{r get_genome_and_parameters}


library(BSgenome.Hsapiens.UCSC.hg19)

genome = BSgenome.Hsapiens.UCSC.hg19.masked

#genNullSeqs('dnabert_input.bed',genomeVersion=genome)

seqnams = GenomeInfoDb::seqnames(human_genome)
chrlens = GenomeInfoDb::seqlengths(human_genome)
chrpos = cumsum(as.numeric(chrlens))
pmax = max(chrpos)
chrpos = c(chrpos,1E12)
chrpos0 = c(0, chrpos)
ichrA = as.character(names(chrlens))

```
```{r helper_functions}
getichrpos = function(ipos){
      j = order(ipos); 
      ipos = sort(ipos); 
      ci = 1;
      res = rep(NA, length(ipos))
      for(i in 1:length(ipos))
      {
        while(ipos[i]>chrpos[ci]){
          ci = ci+1; 
        }
        res[j[i]] = ci
      }
      return(res); 
    }
    
generateRandomGenSeqs = function(seqlens){
      rpos = sample(pmax, length(seqlens), replace = TRUE)
      ichr1 = getichrpos(rpos)
      ichr2 = getichrpos(rpos+seqlens)
      
      jj = which(ichr1!=ichr2)
      while(length(jj)>0){
        rpos[jj] = sample(pmax, length(jj), replace = TRUE)
        ichr1 = getichrpos(rpos)
        ichr2 = getichrpos(rpos+seqlens)
        jj = which(ichr1!=ichr2)
      }
      chr = ichrA[ichr1]
      start = rpos - chrpos0[ichr1];
      names <- chr; 
      ranges <- IRanges::IRanges(start=start, width=seqlens)
      strand <- BiocGenerics::strand(sample(c("+", "-"), length(names), replace=TRUE))
      gr <- GenomicRanges::GRanges(seqnames=names, ranges=ranges, strand=strand)
}

gcContent <- function(seqs)
    {
      alf <- Biostrings::alphabetFrequency(seqs, as.prob=TRUE)
      gc = rowSums(alf[,c("G", "C"), drop=FALSE])
}

matchSeqs = function(gc1, gc2, len1, len2,  gc_th=0.02, len_th=0.02){
      ##
      #  gc1 = rndGC; 
      #  gc2 = inGC; 
      #  len1 = seqlens; 
      #  len2 = seqlens;
      #  rpt1 = inRpt; 
      #  rpt2 = rndRpt; 
      #  gc1=desGC[unmatched];gc2= rndGC;len1= desLens[unmatched];len2= BiocGenerics::width(rndBed);rpt1= desRpt[unmatched];rpt2= rndRpt;
                      
      #  gc_th=0.02
      #  len_th=0.02
      
      
      # gc1, len1 are the desired 
      # gc2 and len2 are to be matched 
      len_th = len_th * len1; 
      
      i1 = order(gc1)
      i2 = order(gc2)
      
      gc1 = gc1[i1]
      gc2 = gc2[i2]
      len1 = len1[i1]
      len2 = len2[i2]
      
      gc2 = c(gc2, 1E10)
      
      len_th = len_th[i1]
      
      m2 = 1; 
      N = length(i1); 
      N2 = length(i2);
      mtc1 = rep(NA, N)
      mtc2 = rep(0, length(i2))
      for(i in 1:N){
        #if(i%%1000==0){cat(i,' ')}
        gc1i = gc1[i]; 
        len1i = len1[i]
        len_thi = len_th[i]
        
        while(gc1i - gc2[m2]>gc_th) {
          m2 = m2+1; 
        }
        if(m2<=N2){
          m2b=m2;
          while(gc2[m2b]-gc1i<=gc_th){
            if ((mtc2[m2b]==0)&(abs(len1i-len2[m2b])<=len_thi)){
              mtc2[m2b]=i; 
              mtc1[i]=m2b;
              if(m2b==m2){m2 = m2+1;}
              break; 
            }
            m2b =m2b+1; 
          }
        }else{break;}
      }
      
      mtc1 = i2[mtc1]
      res = rep(NA, N)
      res[i1] = mtc1; 
      return(res)
}

```

```{r import_bed_file}

inputBedFN = "dnabert_input.bed"
inBed = rtracklayer::import.bed(inputBedFN)
inbed = GenomicRanges::as.data.frame(inBed)
inbed
```
```{r import_sequences}

cat(' importing sequences for',inputBedFN, 'from', GenomeInfoDb::bsgenomeName(human_genome),'\n')

#extract sequences'
inSeqs = Biostrings::getSeq(human_genome, inBed)
seqlens = inbed$width
inGC = gcContent(inSeqs)
```
```{r}
nout = round(nrow(inbed))
outbed=matrix(ncol=ncol(inbed), nrow=nout)
outSeq = rep(inSeqs, length=nout)
colnames(outbed)=colnames(inbed)
unmatched = 1:length(outSeq)
desGC = rep(inGC, length=nout); #desired output GC
desLens = rep(seqlens, length=nout); #desired output lengths 
```

```{r }
nMaxTrials = 150
batchsize = 7000
length_match_tol = 0
GC_match_tol = 0.01
for(iter in 1:nMaxTrials){
      if(length(unmatched)>0){
        cat(' Trial',iter,'out of',nMaxTrials,'\n')
        rndBed = generateRandomGenSeqs(rep(desLens[unmatched],length.out=batchsize))
        rndbed= GenomicRanges::as.data.frame(rndBed)
        cat(' importing sequences\n')
        rndSeqs = Biostrings::getSeq(genome, rndBed)
        rndGC = gcContent(rndSeqs)
        cat(' matching sequences\n')
        
        mtc = matchSeqs(desGC[unmatched], rndGC, desLens[unmatched], BiocGenerics::width(rndBed),
                        gc_th = GC_match_tol,
                        len_th = length_match_tol)
        jj = which(!is.na(mtc))
        if(length(jj)>0){
          #outbed[unmatched[jj],]=rndbed[mtc[jj],];
          outbed[unmatched[jj],1:5]=as.matrix(rndbed[mtc[jj],]);
          outSeq[unmatched[jj],]=rndSeqs[mtc[jj],];
          unmatched = unmatched[-jj]
        }
        cat(nrow(outbed) - length(unmatched),'sequences found so far, ',length(unmatched), ' remaining.\n')
      }
}  

if(length(unmatched)>0){
    outbed = outbed[-unmatched,]
    outSeq = outSeq[-unmatched,]
  }
```
```{r outputs}
outbed = gsub(' ','', outbed)
inseqnams = paste(as.character(inbed[,1]), ':', inbed[,2], '-', inbed[,3], 1:nrow(inbed), sep='')
outseqnams = paste(outbed[,1], ':', outbed[,2], '-', outbed[,3], 1:nrow(outbed), sep='')
out_df = data.frame(pos_names=inseqnams, seq=as.character(inSeqs), neg_names=outseqnams, neg_seq = as.character(outSeq))
```


# ```{r reformat_and_shuffle_for_negative}
# library(universalmotif)
# 
# dss2df = function(dss) {
#   neg_dss = find_random_seq(dss, human_genome, dnabert_input)
#   data.frame(pos_names=names(dss), seq=as.character(dss), neg_names=names(neg_dss), neg_seq = as.character(neg_dss))
# }
# 
# dnabert_input_df = dss2df(dnabert_input_dss)
# dnabert_input_df
# ```

Save in a csv file

```{r save_csv}
library(stringr)
dsname_long = tfbs_title
dsname_pre = str_replace_all(dsname_long,".narrowPeak.gz","")
dsname = str_replace_all(dsname_pre,"wgEncodeAwgTfbs","")
filename=paste("/Users/sjg/Downloads/",dsname,"-ran.csv", sep='')
filename
write.csv(out_df, file=filename)
```

```{r test}
dna_pos = DNAString("GCGCACGCTCCGCAATTTTTCTCCGCCCCCGTCTTCCGGCTTCTCGCGACATCCGCCCAGCGGCGGCCGGAATCTCGCGATAAAGGCTCATTGTCTCGCGG")
dna_neg = DNAString("CACGAGAGGCCTCCACAGTGGGCTCTGCACTCTCCCTGTTGGCAGGAGGCAGCGGGGAGAGGTGAGGCAAGAGGGCCGAGGGCCTGGAATCAAGCCGGAGT")
dna_pos_GC = letterFrequency(dna_pos, "GC", as.prob = TRUE)
dna_neg_GC = letterFrequency(dna_pos, "GC", as.prob = TRUE)
dna_neg_GC
```

Function to create positive and negative sequences from each TFBS dataset

```{r ahub_seq}
ds_create = function(ah, ds) {
  gr = subset(ah, title == ds)[[1]]
  dnabert_input = resize(gr, width = 101, fix = "center")
  human_genome = BSgenome.Hsapiens.UCSC.hg19
  dnabert_input_dss = get_sequence(dnabert_input, human_genome)
  dnabert_input_df = dss2df(dnabert_input_dss)
  dsname_long = ds
  dsname_pre = str_replace_all(dsname_long,".narrowPeak.gz","")
  dsname = str_replace_all(dsname_pre,"wgEncodeAwgTfbs","")
  filename=paste("/Users/sjg/Downloads/tfbs_datasets/",dsname,".csv", sep='')
  # write.csv(dnabert_input_df, file=filename)
}
```

Loop over first 10 tfbs datasets

```{r loop_tfbs}
for (tfbs_ds in df1[[1]][321:340]) {
  ds_create(ah,tfbs_ds)
}
```

## SessionInfo

\scriptsize

```{r sessionInfo, echo=FALSE}
sessionInfo()
```
